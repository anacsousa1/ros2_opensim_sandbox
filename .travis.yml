# This script is used by the Travis-CI (continuous integration) testing
# service to run ROS2 + OpenSim tests with every GitHub push or pull-request.
# To learn about this file, go to https://docs.travis-ci.com/user/languages/minimal-and-generic/
# To test if this file compiles, go to http://www.yamllint.com/
language: generic
cache:
  - apt
os: linux
dist: focal   # Focal = Ubuntu 20.04 LST
# cache: ccache

# Whitelist for travis
branches:
  only:
    - master
    - develop

# Define global variables (for OpenSim installation)
# env:
#   global:
#     # The python tests look for OPENSIM_HOME.
#     - OPENSIM_HOME=~/opensim-core
#     - OPENSIM_DEPENDENCIES_BUILD_DIR=~/opensim_dependencies-build
#     - OPENSIM_DEPENDENCIES_INSTALL_DIR=~/opensim_dependencies-install
#     - SWIG_VER=3.0.8
#     - PATH="$PATH:$TRAVIS_BUILD_DIR/.github"
#     - USE_CCACHE=1
#     - CCACHE_COMPRESS=1
#     # For Clang to work with ccache.
#     - CCACHE_CPP2=1

# Dependencies on linux (for OpenSim installation)
addons:
  apt:
    sources:
      # For gcc >= 4.8:
      - ubuntu-toolchain-r-test
      # For clang:
      - llvm-toolchain-precise-3.5
      # For cmake >= 2.8.8 (for CMakePackageConfigHelpers):
      - kubuntu-backports
      - george-edison55-precise-backports # cmake 3.2.3 / doxygen 1.8.3

    packages:
      # Must explicitly list cmake-data, otherwise the incorrect version of
      # cmake-data will be sought to satisfy the dependencies of cmake:
      - cmake-data
      - cmake
      # For Simbody:
      - liblapack-dev
      # - g++-4.9   # Ubuntu focal already comes with g++ 9.3
      # - clang-3.5 # Ubuntu focal already comes with clang 10.0
      # In case someone wants to check for memory leaks.
      - valgrind
      # To build doxygen documentation.
      # TOO OLD; see below. - doxygen
      # python3 as linux and osx are still on python2
      - python3
      - python3-pip
      - python3-numpy
  # To avoid being prompted when ssh'ing into sourceforge.
  ssh_known_hosts:
      # For uploading doxygen:
      - web.sourceforge.net
      # For deleting old doxygen:
      - shell.sourceforge.net
      # For uploading binaries:
      - frs.sourceforge.net

# Setup and install ros2
before_install:
  - cd $TRAVIS_BUILD_DIR
  # Stop build if comment contains [skip travis].
  - if $(git log -n1 --format="%B" | grep --quiet '\[skip travis\]'); then exit; fi

  #################### ROS2:
  # - sudo locale-gen en_US en_US.UTF-8
  # - sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
  # - export LANG=en_US.UTF-8
  # - sudo apt install curl gnupg2 lsb-release
  # - curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
  # - sudo sh -c 'echo "deb [arch=$(dpkg --print-architecture)] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" > /etc/apt/sources.list.d/ros2-latest.list'
  # - sudo apt update
  # - sudo apt install ros-foxy-desktop
  # - sudo apt install python3-colcon-common-extensions
  # - source /opt/ros/foxy/setup.bash
  # - colcon build
  # - . install/setup.bash
    #################### OpenSim:
  - cd ..
  - sudo apt-get update
  - sudo apt-get --yes install -y swig3.0 git cmake cmake-curses-gui
  - sudo apt-get --yes install  freeglut3-dev libxi-dev libxmu-dev liblapack-dev swig python-dev openjdk-8-jdk
  - export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
  - git clone https://github.com/opensim-org/opensim-core.git
  - mkdir opensim_dependencies_build
  - cd opensim_dependencies_build
  - cmake ../opensim-core/dependencies/ -DCMAKE_INSTALL_PREFIX='~/opensim_dependencies_install' -DCMAKE_BUILD_TYPE=RelWithDebInfo
  - make -j8
  - cd ..
  - mkdir opensim_build
  - cd opensim_build
  - cmake ../opensim-core -DCMAKE_INSTALL_PREFIX="~/opensim_install" -DCMAKE_BUILD_TYPE=RelWithDebInfo -DOPENSIM_DEPENDENCIES_DIR="~/opensim_dependencies_install" -DBUILD_PYTHON_WRAPPING=ON -DBUILD_JAVA_WRAPPING=OFF  -DWITH_BTK=ON
  - make -j2
  - ctest -j2
  - make -j2 install
  - cd /opensim-core/lib/python3.6/site-packages
  - sudo python3 setup.py install
  - cd ..
  

deploy:
  provider: script
  script: bash deploy.sh # correct way to call deploy.sh (see: https://stackoverflow.com/questions/50058931/travis-failed-with-status-code-127)
  # github-token: $GITHUB_TOKEN
  on:
      branch: master
